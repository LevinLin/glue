"use strict";var glue=function(n,e){var t,o,i,c,r,a,s,u,l=function(){var t,o={};return o.open=function(){try{var i;i=n.match("^https://")?"wss"+n.substr(5):"ws"+n.substr(4),i+=e.baseURL+"ws",t=new WebSocket(i),t.onmessage=function(n){o.onMessage(n.data.toString())},t.onerror=function(n){var e="the websocket closed the connection with ";e+=n.code?"the error code: "+n.code:"an error.",o.onError(e)},t.onclose=function(){o.onClose()},t.onopen=function(){o.onOpen()}}catch(c){o.onError()}},o.send=function(n){t.send(n)},o.reset=function(){t&&t.close(),t=void 0},o},f=function(){var t,o,i,c=n+e.baseURL+"ajax",r=8e3,a=45e3,s={Delimiter:"&",Init:"i",Push:"u",Poll:"o"},u={},l=!1,f=!1,d=function(){i=function(){},l&&l.abort(),f&&f.abort()},g=function(n){d(),n=n?"the ajax socket closed the connection with the error: "+n:"the ajax socket closed the connection with an error.",u.onError(n)},v=function(n,e){f=$.ajax({url:c,success:function(n){f=!1,e&&e(n)},error:function(n,e){f=!1,g(e)},type:"POST",data:n,dataType:"text",timeout:r})};return i=function(){l=$.ajax({url:c,success:function(n){l=!1;var e=n.indexOf(s.Delimiter);return 0>e?void g("ajax socket: failed to split poll token from data!"):(o=n.substring(0,e),n=n.substr(e+1),i(),void u.onMessage(n))},error:function(n,e){l=!1,g(e)},type:"POST",data:s.Poll+t+s.Delimiter+o,dataType:"text",timeout:a})},u.open=function(){v(s.Init,function(n){var e=n.indexOf(s.Delimiter);return 0>e?void g("ajax socket: failed to split uid and poll token from data!"):(t=n.substring(0,e),o=n.substr(e+1),i(),void u.onOpen())})},u.send=function(n){v(s.Push+t+s.Delimiter+n)},u.reset=function(){d()},u},d="1.3.0",g="&",v="m",h={WebSocket:"WebSocket",AjaxSocket:"AjaxSocket"},m={Len:2,Init:"in",Ping:"pi",Pong:"po",Close:"cl",Invalid:"iv",ChannelData:"cd"},p={Disconnected:"disconnected",Connecting:"connecting",Reconnecting:"reconnecting",Connected:"connected"},b={baseURL:"/glue/",forceSocketType:!1,connectTimeout:1e4,pingInterval:35e3,pingReconnectTimeout:5e3,reconnected:!0,reconnectDelay:1e3,reconnectDelayMax:5e3,reconnectAttempts:10,resetSendBufferTimeout:1e4},k=!1,x=!1,T=p.Disconnected,y=0,D=!1,S=!1,w=!1,M=[],C=!1,O=!1,L=!1,R=[],P=new function(){this.unmarshalValues=function(n){if(!n)return!1;var e=n.indexOf(g),t=parseInt(n.substring(0,e),10);if(n=n.substring(e+1),0>t||t>n.length)return!1;var o=n.substr(0,t),i=n.substr(t);return{first:o,second:i}},this.marshalValues=function(n,e){return String(n.length)+g+n+e}},j=new function(){var n={},e=function(n){return new function(){var e=this;this.onMessageFunc=function(){},this.instance={onMessage:function(n){e.onMessageFunc=n},send:function(e,t){return e?a(m.ChannelData,P.marshalValues(n,e),t):-1}}}};this.get=function(t){if(!t)return!1;var o=n[t];return o?o.instance:(o=e(t),n[t]=o,o.instance)},this.emitOnMessage=function(e,t){if(e&&t){var o=n[e];if(!o)return void console.log("glue: channel '"+e+"': emit onMessage event: channel does not exists");try{o.onMessageFunc(t)}catch(i){return void console.log("glue: channel '"+e+"': onMessage event call failed: "+i.message)}}}};r=function(n){return k?L?void k.send(n):void R.push(n):void 0};var I=function(){if(0!=R.length){for(var n=0;n<R.length;n++)r(R[n]);R=[]}},U=function(){O=!1,C!==!1&&(clearTimeout(C),C=!1)},A=function(){C!==!1||O||(C=setTimeout(function(){if(C=!1,O=!0,0!=M.length){for(var n,e=0;e<M.length;e++)if(n=M[e],n.discardCallback&&$.isFunction(n.discardCallback))try{n.discardCallback(n.data)}catch(t){console.log("glue: failed to call discard callback: "+t.message)}u("discard_send_buffer"),M=[]}},e.resetSendBufferTimeout))},W=function(){if(U(),0!=M.length){for(var n,e=0;e<M.length;e++)n=M[e],r(n.cmd+n.data);M=[]}};a=function(n,e,t){return e||(e=""),k&&T===p.Connected?(r(n+e),1):O?(t&&$.isFunction(t)&&t(e),-1):(A(),M.push({cmd:n,data:e,discardCallback:t}),0)};var E=function(){D!==!1&&(clearTimeout(D),D=!1)},F=function(){E(),D=setTimeout(function(){D=!1,u("connect_timeout"),s()},e.connectTimeout)},V=function(){S!==!1&&(clearTimeout(S),S=!1),w!==!1&&(clearTimeout(w),w=!1)},q=function(){V(),S=setTimeout(function(){S=!1,r(m.Ping),w=setTimeout(function(){w=!1,u("timeout"),s()},e.pingReconnectTimeout)},e.pingInterval)},_=function(){return x?void(k=o()):y>1?(o=f,k=o(),void(i=h.AjaxSocket)):(!e.forceSocketType&&window.WebSocket||e.forceSocketType===h.WebSocket?(o=l,i=h.WebSocket):(o=f,i=h.AjaxSocket),void(k=o()))},B=function(n){n=JSON.parse(n),L=!0,I(),T=p.Connected,u("connected"),setTimeout(W,0)},J=function(){_(),k.onOpen=function(){E(),y=0,x=!0,q();var n={version:d};n=JSON.stringify(n),k.send(m.Init+n)},k.onClose=function(){s()},k.onError=function(n){u("error",[n]),s()},k.onMessage=function(n){if(q(),n.length<m.Len)return void console.log("glue: received invalid data from server: data is too short.");var e=n.substr(0,m.Len);if(n=n.substr(m.Len),e===m.Ping)r(m.Pong);else if(e===m.Pong);else if(e===m.Invalid)console.log("glue: server replied with an invalid request notification!");else if(e===m.Init)B(n);else if(e===m.ChannelData){var t=P.unmarshalValues(n);if(!t)return void console.log("glue: server requested an invalid channel data request: "+n);j.emitOnMessage(t.first,t.second)}else console.log("glue: received invalid data from server with command '"+e+"' and data '"+n+"'!")},setTimeout(function(){y>0?(T=p.Reconnecting,u("reconnecting")):(T=p.Connecting,u("connecting")),F(),k.open()},0)},N=function(){E(),V(),L=!1,R=[],k&&(k.onOpen=k.onClose=k.onMessage=k.onError=function(){},k.reset(),k=!1)};if(s=function(){if(N(),e.reconnectAttempts>0&&y>e.reconnectAttempts||e.reconnect===!1)return T=p.Disconnected,void u("disconnected");y+=1;var n=e.reconnectDelay*y;n>e.reconnectDelayMax&&(n=e.reconnectDelayMax),setTimeout(function(){J()},n)},c=function(){k&&(r(m.Close),N(),T=p.Disconnected,u("disconnected"))},t=j.get(v),n||(n=window.location.protocol+"//"+window.location.host),!n.match("^http://")&&!n.match("^https://"))return void console.log("glue: invalid host: missing 'http://' or 'https://'!");e=$.extend(b,e),e.reconnectDelayMax<e.reconnectDelay&&(e.reconnectDelayMax=e.reconnectDelay),0!==e.baseURL.indexOf("/")&&(e.baseURL="/"+e.baseURL),"/"!==e.baseURL.slice(-1)&&(e.baseURL=e.baseURL+"/"),J();var H={version:function(){return d},type:function(){return i},state:function(){return T},send:function(n,e){t.send(n,e)},onMessage:function(n){t.onMessage(n)},on:function(){var n=$(H);n.on.apply(n,arguments)},reconnect:function(){T===p.Disconnected&&(y=0,s())},close:function(){c()},channel:function(n){return j.get(n)}};return u=function(){var n=$(H);n.triggerHandler.apply(n,arguments)},H};
"use strict";var glue=function(e,n){var t,o,c,i,r=function(){var n,t={};return t.open=function(){try{var o;o=e.match("^https://")?"wss"+e.substr(5):"ws"+e.substr(4),o+="/glue/ws",n=new WebSocket(o),n.onmessage=function(e){t.onMessage(e.data.toString())},n.onerror=function(e){var n="the websocket closed the connection with ";n+=e.code?"the error code: "+e.code:"an error.",t.onError(n)},n.onclose=function(){t.onClose()},n.onopen=function(){t.onOpen()}}catch(c){t.onError()}},t.send=function(e){n.send(e)},t.reset=function(){n&&n.close(),n=void 0},t},s=function(){var n,t,o,c=e+"/glue/ajax",i=8e3,r=45e3,s={Delimiter:"&",Init:"i",Push:"u",Poll:"o"},a={},u=!1,l=!1,d=function(){o=function(){},u&&u.abort(),l&&l.abort()},f=function(e){d(),e=e?"the ajax socket closed the connection with the error: "+e:"the ajax socket closed the connection with an error.",a.onError(e)},g=function(e,n){l=$.ajax({url:c,success:function(e){l=!1,n&&n(e)},error:function(e,n){l=!1,f(n)},type:"POST",data:e,dataType:"text",timeout:i})};return o=function(){u=$.ajax({url:c,success:function(e){u=!1;var n=e.indexOf(s.Delimiter);return 0>n?void f("ajax socket: failed to split poll token from data!"):(t=e.substring(0,n),e=e.substr(n+1),o(),void a.onMessage(e))},error:function(e,n){u=!1,f(n)},type:"POST",data:s.Poll+n+s.Delimiter+t,dataType:"text",timeout:r})},a.open=function(){g(s.Init,function(e){var c=e.indexOf(s.Delimiter);return 0>c?void f("ajax socket: failed to split uid and poll token from data!"):(n=e.substring(0,c),t=e.substr(c+1),o(),void a.onOpen())})},a.send=function(e){g(s.Push+n+s.Delimiter+e)},a.reset=function(){d()},a},a={WebSocket:"WebSocket",AjaxSocket:"AjaxSocket"},u={Len:1,Ping:"i",Pong:"o",Data:"d",Close:"c",Invalid:"z"},l={Disconnected:"disconnected",Connecting:"connecting",Reconnecting:"reconnecting",Connected:"connected"},d={forceSocketType:!1,connectTimeout:1e4,pingInterval:35e3,pingReconnectTimeout:5e3,reconnected:!0,reconnectDelay:1e3,reconnectDelayMax:5e3,reconnectAttempts:10,resetSendBufferTimeout:7e3},f=!1,g=!1,m=l.Disconnected,p=0,v=!1,h=!1,T=!1,D=[],x=!1,y=!1,k=function(){},b=function(){y=!1,x!==!1&&(clearTimeout(x),x=!1)},S=function(){x!==!1||y||(x=setTimeout(function(){x=!1,y=!0,D.length>0&&i("discard_send_buffer",[D]),D=[]},n.resetSendBufferTimeout))},w=function(){if(b(),0!=D.length){for(var e=0;e<D.length;e++)f.send(u.Data+D[e]);D=[]}},P=function(){v!==!1&&(clearTimeout(v),v=!1)},j=function(){P(),v=setTimeout(function(){v=!1,i("connect_timeout"),c()},n.connectTimeout)},C=function(){h!==!1&&(clearTimeout(h),h=!1),T!==!1&&(clearTimeout(T),T=!1)},M=function(){C(),h=setTimeout(function(){h=!1,f.send(u.Ping),T=setTimeout(function(){T=!1,i("timeout"),c()},n.pingReconnectTimeout)},n.pingInterval)},O=function(){return g?void(f=t()):p>1?(t=s,f=t(),void(o=a.AjaxSocket)):(!n.forceSocketType&&window.WebSocket||n.forceSocketType===a.WebSocket?(t=r,o=a.WebSocket):(t=s,o=a.AjaxSocket),void(f=t()))},A=function(){setTimeout(function(){O(),f.onOpen=function(){P(),p=0,g=!0,M(),m=l.Connected,i("connected"),setTimeout(w,0)},f.onClose=function(){c()},f.onError=function(e){i("error",[e]),c()},f.onMessage=function(e){if(M(),e.length<u.Len)return void console.log("glue: received invalid data from server: data is too short.");var n=e.substr(0,u.Len);if(e=e.substr(u.Len),n===u.Ping)f.send(u.Pong);else if(n===u.Pong);else if(n===u.Invalid)console.log("glue: server replied with an invalid request notification!");else if(n===u.Data){if(e)try{k(e)}catch(t){console.log("glue: onMessage event call failed: "+t.message)}}else console.log("glue: received invalid data from server with command '"+n+"' and data '"+e+"'!")},p>0?(m=l.Reconnecting,i("reconnecting")):(m=l.Connecting,i("connecting")),j(),f.open()},0)},I=function(){f&&(P(),C(),f.onOpen=f.onClose=f.onMessage=f.onError=function(){},f.reset(),f=!1)};if(c=function(){if(I(),n.reconnectAttempts>0&&p>n.reconnectAttempts||n.reconnect===!1)return m=l.Disconnected,void i("disconnected");p+=1;var e=n.reconnectDelay*p;e>n.reconnectDelayMax&&(e=n.reconnectDelayMax),setTimeout(function(){A()},e)},e||(e=window.location.protocol+"//"+window.location.host),!e.match("^http://")&&!e.match("^https://"))return void console.log("glue: invalid host: missing 'http://' or 'https://'!");n=$.extend(d,n),n.reconnectDelayMax<n.reconnectDelay&&(n.reconnectDelayMax=n.reconnectDelay),A();var W={type:function(){return o},state:function(){return m},send:function(e){return f&&m===l.Connected?(f.send(u.Data+e),1):y?-1:(S(),D.push(e),0)},onMessage:function(e){k=e},on:function(){var e=$(W);e.on.apply(e,arguments)},reconnect:function(){m===l.Disconnected&&(p=0,c())},close:function(){f&&(m===l.Connected&&f.send(u.Close),I(),m=l.Disconnected,i("disconnected"))}};return i=function(){var e=$(W);e.triggerHandler.apply(e,arguments)},W};
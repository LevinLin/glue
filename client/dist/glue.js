"use strict";var glue=function(n,e){var t,o,i,c,r,a,s,u,l=function(){var e,t={};return t.open=function(){try{var o;o=n.match("^https://")?"wss"+n.substr(5):"ws"+n.substr(4),o+="/glue/ws",e=new WebSocket(o),e.onmessage=function(n){t.onMessage(n.data.toString())},e.onerror=function(n){var e="the websocket closed the connection with ";e+=n.code?"the error code: "+n.code:"an error.",t.onError(e)},e.onclose=function(){t.onClose()},e.onopen=function(){t.onOpen()}}catch(i){t.onError()}},t.send=function(n){e.send(n)},t.reset=function(){e&&e.close(),e=void 0},t},f=function(){var e,t,o,i=n+"/glue/ajax",c=8e3,r=45e3,a={Delimiter:"&",Init:"i",Push:"u",Poll:"o"},s={},u=!1,l=!1,f=function(){o=function(){},u&&u.abort(),l&&l.abort()},d=function(n){f(),n=n?"the ajax socket closed the connection with the error: "+n:"the ajax socket closed the connection with an error.",s.onError(n)},g=function(n,e){l=$.ajax({url:i,success:function(n){l=!1,e&&e(n)},error:function(n,e){l=!1,d(e)},type:"POST",data:n,dataType:"text",timeout:c})};return o=function(){u=$.ajax({url:i,success:function(n){u=!1;var e=n.indexOf(a.Delimiter);return 0>e?void d("ajax socket: failed to split poll token from data!"):(t=n.substring(0,e),n=n.substr(e+1),o(),void s.onMessage(n))},error:function(n,e){u=!1,d(e)},type:"POST",data:a.Poll+e+a.Delimiter+t,dataType:"text",timeout:r})},s.open=function(){g(a.Init,function(n){var i=n.indexOf(a.Delimiter);return 0>i?void d("ajax socket: failed to split uid and poll token from data!"):(e=n.substring(0,i),t=n.substr(i+1),o(),void s.onOpen())})},s.send=function(n){g(a.Push+e+a.Delimiter+n)},s.reset=function(){f()},s},d="1.2.0",g="&",v="m",h={WebSocket:"WebSocket",AjaxSocket:"AjaxSocket"},m={Len:2,Init:"in",Ping:"pi",Pong:"po",Close:"cl",Invalid:"iv",ChannelData:"cd"},p={Disconnected:"disconnected",Connecting:"connecting",Reconnecting:"reconnecting",Connected:"connected"},b={forceSocketType:!1,connectTimeout:1e4,pingInterval:35e3,pingReconnectTimeout:5e3,reconnected:!0,reconnectDelay:1e3,reconnectDelayMax:5e3,reconnectAttempts:10,resetSendBufferTimeout:1e4},k=!1,T=!1,x=p.Disconnected,y=0,D=!1,S=!1,w=!1,M=[],C=!1,O=!1,P=!1,j=[],I=new function(){this.unmarshalValues=function(n){if(!n)return!1;var e=n.indexOf(g),t=parseInt(n.substring(0,e),10);if(n=n.substring(e+1),0>t||t>n.length)return!1;var o=n.substr(0,t),i=n.substr(t);return{first:o,second:i}},this.marshalValues=function(n,e){return String(n.length)+g+n+e}},A=new function(){var n={},e=function(n){return new function(){var e=this;this.onMessageFunc=function(){},this.instance={onMessage:function(n){e.onMessageFunc=n},send:function(e,t){return e?a(m.ChannelData,I.marshalValues(n,e),t):-1}}}};this.get=function(t){if(!t)return!1;var o=n[t];return o?o.instance:(o=e(t),n[t]=o,o.instance)},this.emitOnMessage=function(e,t){if(e&&t){var o=n[e];if(!o)return void console.log("glue: channel '"+e+"': emit onMessage event: channel does not exists");try{o.onMessageFunc(t)}catch(i){return void console.log("glue: channel '"+e+"': onMessage event call failed: "+i.message)}}}};r=function(n){return k?P?void k.send(n):void j.push(n):void 0};var W=function(){if(0!=j.length){for(var n=0;n<j.length;n++)r(j[n]);j=[]}},E=function(){O=!1,C!==!1&&(clearTimeout(C),C=!1)},F=function(){C!==!1||O||(C=setTimeout(function(){if(C=!1,O=!0,0!=M.length){for(var n,e=0;e<M.length;e++)if(n=M[e],n.discardCallback&&$.isFunction(n.discardCallback))try{n.discardCallback(n.data)}catch(t){console.log("glue: failed to call discard callback: "+t.message)}u("discard_send_buffer"),M=[]}},e.resetSendBufferTimeout))},L=function(){if(E(),0!=M.length){for(var n,e=0;e<M.length;e++)n=M[e],r(n.cmd+n.data);M=[]}};a=function(n,e,t){return e||(e=""),k&&x===p.Connected?(r(n+e),1):O?(t&&$.isFunction(t)&&t(e),-1):(F(),M.push({cmd:n,data:e,discardCallback:t}),0)};var R=function(){D!==!1&&(clearTimeout(D),D=!1)},V=function(){R(),D=setTimeout(function(){D=!1,u("connect_timeout"),s()},e.connectTimeout)},q=function(){S!==!1&&(clearTimeout(S),S=!1),w!==!1&&(clearTimeout(w),w=!1)},_=function(){q(),S=setTimeout(function(){S=!1,r(m.Ping),w=setTimeout(function(){w=!1,u("timeout"),s()},e.pingReconnectTimeout)},e.pingInterval)},B=function(){return T?void(k=o()):y>1?(o=f,k=o(),void(i=h.AjaxSocket)):(!e.forceSocketType&&window.WebSocket||e.forceSocketType===h.WebSocket?(o=l,i=h.WebSocket):(o=f,i=h.AjaxSocket),void(k=o()))},J=function(n){n=JSON.parse(n),P=!0,W(),x=p.Connected,u("connected"),setTimeout(L,0)},N=function(){B(),k.onOpen=function(){R(),y=0,T=!0,_();var n={version:d};n=JSON.stringify(n),k.send(m.Init+n)},k.onClose=function(){s()},k.onError=function(n){u("error",[n]),s()},k.onMessage=function(n){if(_(),n.length<m.Len)return void console.log("glue: received invalid data from server: data is too short.");var e=n.substr(0,m.Len);if(n=n.substr(m.Len),e===m.Ping)r(m.Pong);else if(e===m.Pong);else if(e===m.Invalid)console.log("glue: server replied with an invalid request notification!");else if(e===m.Init)J(n);else if(e===m.ChannelData){var t=I.unmarshalValues(n);if(!t)return void console.log("glue: server requested an invalid channel data request: "+n);A.emitOnMessage(t.first,t.second)}else console.log("glue: received invalid data from server with command '"+e+"' and data '"+n+"'!")},setTimeout(function(){y>0?(x=p.Reconnecting,u("reconnecting")):(x=p.Connecting,u("connecting")),V(),k.open()},0)},H=function(){R(),q(),P=!1,j=[],k&&(k.onOpen=k.onClose=k.onMessage=k.onError=function(){},k.reset(),k=!1)};if(s=function(){if(H(),e.reconnectAttempts>0&&y>e.reconnectAttempts||e.reconnect===!1)return x=p.Disconnected,void u("disconnected");y+=1;var n=e.reconnectDelay*y;n>e.reconnectDelayMax&&(n=e.reconnectDelayMax),setTimeout(function(){N()},n)},c=function(){k&&(r(m.Close),H(),x=p.Disconnected,u("disconnected"))},t=A.get(v),n||(n=window.location.protocol+"//"+window.location.host),!n.match("^http://")&&!n.match("^https://"))return void console.log("glue: invalid host: missing 'http://' or 'https://'!");e=$.extend(b,e),e.reconnectDelayMax<e.reconnectDelay&&(e.reconnectDelayMax=e.reconnectDelay),N();var z={version:function(){return d},type:function(){return i},state:function(){return x},send:function(n,e){t.send(n,e)},onMessage:function(n){t.onMessage(n)},on:function(){var n=$(z);n.on.apply(n,arguments)},reconnect:function(){x===p.Disconnected&&(y=0,s())},close:function(){c()},channel:function(n){return A.get(n)}};return u=function(){var n=$(z);n.triggerHandler.apply(n,arguments)},z};